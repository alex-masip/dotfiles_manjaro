var lastResponse,loginFormSubmit=$("#connexion-submit"),loginSection=$("#login"),loginLinkElement=$("#loginlink"),logoutButton=$("#logout"),userMenu=$("#tc-identifier-user"),tagsContainer=$("#tagscontainer"),varsLink=$("#varslink"),varsContainer=$("#varscontainer"),exportLink=$("#export"),cookiesContainer=$("#cookiescontainer"),scriptsLink=$("#scriptslink"),pixelsLink=$("#pixelslink"),domain="platform",loginURL="https://"+domain+".commandersact.com/crossroad/login_check",listContainerVersionsURL="https://"+domain+".commandersact.com/en/{idSite}/containers/extension/getversions/{idContainer}",listSitesURL="https://"+domain+".commandersact.com/en/0/extension/getsites",listContainersURL="https://"+domain+".commandersact.com/en/0/extension/getcontainers",logoutURL="http://"+domain+".commandersact.com/logout",background=chrome.extension.getBackgroundPage(),popup={isContainerSorted:!1,containers:[],intervalId:0,initHandlers:function(){var o=this;window.addEventListener("load",this.initGetInfos.bind(this),!1),window.addEventListener("load",this.checkConnexion.bind(this),!1),window.addEventListener("load",this.checkSession.bind(this),!1),loginLinkElement.on("click",$.proxy(this.initLoginForm,this)),loginFormSubmit.on("click",$.proxy(this.login,this)),$(document).on("change","select",this.changeContainerVersion),$(document).on("click",".restore",this.restoreDefaultContainerVersion),varsLink.on("click",$.proxy(this.getVars,this)),$(".var-filter").on("click",this.changeVarFilter),$(document).on("click",".collapse-link",this.collapseLink),exportLink.on("click",$.proxy(this.initExportLink,this)),scriptsLink.on("click",$.proxy(this.getScripts,this)),pixelsLink.on("click",$.proxy(this.getPixels,this)),logoutButton.on("click",$.proxy(this.logout,this)),chrome.runtime.onMessage.addListener(function(e,n,t){e.logout&&o.logout()})},collapseLink:function(){$(this).hide().next().removeClass("hide")},initExportLink:function(e){this.generateExcel("varstable",e)},checkConnexion:function(){background.isConnected?(userMenu.show(),this.getAccessSites(),this.getContainers(),this.refreshContainers(),loginLinkElement.hide()):(userMenu.hide(),loginLinkElement.show())},checkSession:function(){background.isConnected&&$("body").hover(function(){chrome.alarms.clear("reactivateSession")},function(){chrome.alarms.create("reactivateSession",{delayInMinutes:23})})},getAccessSites:function(){$.get(listSitesURL).done(function(e){chrome.storage.local.set({sitesAllowed:e})})},getVars:function(){var n=$.proxy(this.showVars,this);chrome.tabs.query({active:!0,currentWindow:!0},function(e){chrome.tabs.sendMessage(e[0].id,{name:"popup",subject:"vars"},n)})},getScripts:function(){var n=this;chrome.tabs.query({active:!0,currentWindow:!0},function(e){chrome.tabs.sendMessage(e[0].id,{name:"popup",subject:"scripts"},n.showScripts)})},getPixels:function(){var n=this;chrome.tabs.query({active:!0,currentWindow:!0},function(e){chrome.tabs.sendMessage(e[0].id,{name:"popup",subject:"pixels"},n.showPixels)})},initLoginForm:function(){background.isConnected?loginLinkElement.addClass("connected"):(loginLinkElement.hide(),loginSection.addClass("visible"),chrome.storage.local.get("username",function(e){e.username&&(document.getElementById("connection-name").value=e.username)}))},login:function(e){e.preventDefault();var n=this,t=$("#connection-name").val(),o=$("#connection-pass").val();chrome.storage.local.set({username:t}),$.ajax({url:loginURL,data:{_login:t,_password:o},method:"POST",dataType:"json",beforeSend:function(e){e.setRequestHeader("Content-type","application/x-www-form-urlencoded"),e.setRequestHeader("X-Requested-With","XMLHttpRequest")},statusCode:{401:function(){$("#connection-info").text("The email or password doesn't match any account.").css("color","red")}}}).done(function(e){$("#connection-info").text(""),$("#connection-name, #connection-pass").val(""),background.isConnected=!0,loginSection.removeClass("visible"),loginLinkElement.addClass("connected"),userMenu.show(),chrome.storage.local.get("username",function(e){e.username&&$("#user-information").html(e.username)}),n.getAccessSites(),n.getContainers(),n.refreshContainers(),chrome.runtime.sendMessage({name:"login"}),chrome.tabs.query({active:!0,currentWindow:!0},function(e){chrome.tabs.reload(e[0].id),window.close()})})},logout:function(){$.get(logoutURL).always(function(){window.location.href="popup.html",clearInterval(popup.intervalId)})},getContainers:function(){var n=this;chrome.tabs.query({active:!0,currentWindow:!0},function(e){chrome.tabs.sendMessage(e[0].id,{name:"popup",subject:"containers"},n.getContainersVersion.bind(n))})},refreshContainers:function(){popup.intervalId=setInterval(function(){background.isConnected&&popup.getContainers()},2e3)},showContainers:function(e){if("SELECT"!==document.activeElement.tagName||document.activeElement.options.length!=e.versions.length){var n=$("#container"+e.idSite+"_"+e.idContainer);n.parent("ul").data("position",e.position),n.text(e.label);var t=$("<select>");for(var o in t.attr({"container-url":e.url,"container-siteid":e.idSite,"container-id":e.idContainer,"container-name":e.label}),e.versions){var i=e.versions[o].tc_version,a=e.versions[o].id_tc_version,s=i==e.versionLabel;$("<option />",{value:a,text:i,selected:s}).appendTo(t)}0<n.next("select").length?n.next("select").html($(t).html()):t.insertAfter(n);var r=!0;for(containerToReplace in background.containersToReplace)background.containersToReplace[containerToReplace].site==e.idSite&&background.containersToReplace[containerToReplace].container==e.idContainer&&(r=!1);if(!r){var c=n.next("select"),l=$("<span />").addClass("restore").html('<a class="btn btn-success">restore default</a>');0==c.next("span.restore").length&&l.insertAfter(c)}}},getContainersVersion:function(l,e){var d=this;void 0!==l&&0!==l.length&&(d.containers=l,chrome.storage.local.get("sitesAllowed",function(e){var c=Object.keys(e.sitesAllowed);for(var n in l){var t=l[n].idSite,o=l[n].idContainer;l[n].versionLabel=background.containersToReplace[t+"_"+o]?background.containersToReplace[t+"_"+o].versionLabel:l[n].versionLabel}$.post(listContainersURL,{containers:l}).done(function(e){for(var n in e){var t=e[n].idSite,o=e[n].idContainer;if(e[n].noRight||-1===c.indexOf(t.toString()))$("#container"+t+"_"+o).next("select").remove(),$("#container"+t+"_"+o).find("span.label-warning").remove(),$("#container"+t+"_"+o).append(' <span class="label label-warning">no right on this container</span>');else{var i=l.find(function(e){return e.idContainer==o&&e.idSite==t});e[n].position=i.position,d.showContainers(e[n])}}if(!d.isContainerSorted){var a=tagsContainer.children("ul");a.sort(function(e,n){var t=$(e).data("position"),o=$(n).data("position");return o<t?1:t<o?-1:0});for(var s="",r=0;r<a.length;r++)s+='<ul class="list-group">'+a.eq(r).html()+"</ul>";tagsContainer.html(s),d.isContainerSorted=!0}})}))},restoreDefaultContainerVersion:function(e){var n=$(e.currentTarget),t=n.prev("select"),o=$(t).attr("container-siteid"),i=$(t).attr("container-id");for(containerToReplace in background.containersToReplace)background.containersToReplace[containerToReplace].site==o&&background.containersToReplace[containerToReplace].container==i&&delete background.containersToReplace[containerToReplace];chrome.storage.local.get("containersToReplace",function(e){if(e.containersToReplace){var n=e.containersToReplace;n[o+"_"+i]&&(delete n[o+"_"+i],chrome.storage.local.remove("containersToReplace"),chrome.storage.local.set({containersToReplace:n}))}}),n.remove(),chrome.tabs.query({active:!0,currentWindow:!0},function(e){chrome.tabs.reload(e[0].id),window.close()})},changeContainerVersion:function(e){var o=$(e.currentTarget),i=chrome.storage.local,a=o.attr("container-siteid"),s=o.attr("container-id"),r=o.attr("container-name"),c=o.attr("container-url");void 0!==a&&void 0!==s&&i.get("containersToReplace",function(e){if(e.containersToReplace)n=e.containersToReplace;else var n={};var t={url:(c.match(/(?:.*\/)*(.+\.js).*/)||[])[1],site:a,container:s,containerName:r,version:o.val(),versionLabel:o.find("option:selected").text()};n[a+"_"+s]=t,background.addContainersToReplace(n),i.set({containersToReplace:n}),chrome.tabs.query({active:!0,currentWindow:!0},function(e){chrome.tabs.reload(e[0].id),window.close()})})},changeVarFilter:function(e){var n=$(e.currentTarget),t=n.attr("id"),o=$("table#varstable");switch($(".var-filter").removeClass("active"),n.addClass("active"),t){case"vars-defined":o.find("tr.var-undefined").css("display","none"),o.find("tr.var-defined").css("display","table-row");break;case"vars-undefined":o.find("tr.var-defined").css("display","none"),o.find("tr.var-undefined").css("display","table-row");break;default:o.find("tr").css("display","table-row")}},initGetInfos:function(){var t=this;chrome.tabs.query({active:!0,currentWindow:!0},function(e){chrome.tabs.sendMessage(e[0].id,{name:"popup",subject:"tags"},t.getTags),chrome.cookies.getAll({url:e[0].url},function(e){var n={name:"background",subject:"cookies",content:e};t.showCookies(n)})})},refreshTagsInfo:function(){var n=this;chrome.tabs.query({active:!0,currentWindow:!0},function(e){chrome.tabs.sendMessage(e[0].id,{name:"popup",subject:"tags"},n.getTags)})},getTags:function(e){if(e&&e.tags){if(0===e.containers.length){var n=$.map(e.tags,function(e){return[e.idSite,e.idContainer].join("_")});n=$.unique(n),e.containers=$.map(n,function(e){var n=e.split("_");return{idSite:n[0],idContainer:n[1]}})}var t=JSON.stringify(e);if(lastResponse!==t){for(var o="",i=0;i<e.containers.length;i++){o+='<ul class="list-group"><span class="containerID" id="'+(a="container"+e.containers[i].idSite+"_"+e.containers[i].idContainer)+'">Container '+(i+1)+"</span></ul>"}for(var i in o&&tagsContainer.html(o),e.tags){var a="container"+e.tags[i].idSite+"_"+e.tags[i].idContainer;$("#"+a).after('<li class="tag list-group-item">'+e.tags[i].name+"</li>")}tagsContainer.find("span").each(function(){"LI"!==$(this).next().prop("tagName")&&$(this).after('<li class="tag list-group-item">(No active tags)</li>')}),lastResponse=t}}},showVars:function(e){var n=[];for(var t in e){var o='<tr class="'+(""!==e[t]?"var-defined":"var-undefined")+'"><td>'+t+"</td><td>"+this.showValue(e[t])+"</td></tr>";n.push(o)}if(n.length)var i='<table id="varstable" class="variablestable table table-striped">'+n.join("")+"</table>";else i="No vars found yet";varsContainer.html(i)},showValue:function(e){switch(typeof e){case"string":case"number":return""===e?'<i class="muted">(empty)</i>':e;case"object":if(null===e)return'<i class="muted">(empty)</i>';var n=[],t="properties";for(var o in e)e.hasOwnProperty(o)&&(o.match(/^\d+$/)?(t="items",n.push("<tr><td>"+this.showValue(e[o])+"</td></tr>")):n.push("<tr><td>"+[o,this.showValue(e[o])].join(": ")+"</td></tr>"));return n.length?"<a href='javascript:;' class='collapse-link'>"+["Show",n.length,t].join(" ")+"</a><table class='hide table table-striped'>"+n.join("")+"</table>":'<i class="muted">(empty)</i>';default:return"?"}},showCookies:function(e){var n="";if(e){for(var t in n+='<table class="cookiestable table table-striped">',e.content)n+='<tr><td class="active" style="margin-bottom: 20px;">'+e.content[t].name+"</td><td>"+e.content[t].value+"</td></tr>";n+="</table>",0<e.content.length?cookiesContainer.html(n):cookiesContainer.html("No cookies found yet")}},showScripts:function(e){var n="";if(Object.prototype.toString.call(e)&&0<e.length){for(var t in n+='<table class="cookiestable table table-striped">',e){var o=Math.round(e[t].duration);300<o?o='<span style="color:red">'+o+"ms</span>":o+="ms",n+='<tr><td class="active" style="margin-bottom: 20px;"><div class="ellipsis"><a class="networklink" href="'+e[t].name+'" title="'+e[t].name+'" target="_blank">'+e[t].name+"</a></div></td><td>"+o+"</td></tr>"}n+="</table>",$("#scripts").html(n)}else $("#scripts").html("No scripts found yet")},showPixels:function(e){var n="";if(Object.prototype.toString.call(e)&&0<e.length){for(var t in n+='<table class="cookiestable table table-striped">',e)n+='<tr><td class="active" style="margin-bottom: 20px;"><div class="ellipsis"><a class="networklink" href="'+e[t].name+'" title="'+e[t].name+'" target="_blank">'+e[t].name+"</a></div></td><td>"+Math.round(e[t].duration)+"ms</td></tr>";n+="</table>",$("#pixels").html(n)}else $("#pixels").html("No pixels found yet")},generateExcel:function(e,n){var t=document.getElementById(e).outerHTML,o=$(n.currentTarget);o.attr("download",e+"Download.xls"),o.attr("href","data:application/vnd.ms-excel,"+encodeURIComponent(t))}};popup.initHandlers(),window.addEventListener("load",function(){setInterval(function(e){e.refreshTagsInfo()},2e3,popup)});